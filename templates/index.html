<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سایت آگهی کار</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        body { 
            font-family: Vazirmatn, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .navbar { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .main-content {
            margin-top: 100px;
            padding: 2rem;
        }
        .welcome-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 3rem;
        }
        .btn-main {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            margin: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
        }
        .btn-main:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.5rem;
            color: #667eea;
            margin: 0 1rem;
        }
        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .global-alert {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 600px;
            width: 90%;
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 2rem 0;
        }
        .category-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: bold;
            color: #667eea;
        }
        .category-btn:hover, .category-btn.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .search-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .job-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .job-seeker { border-right: 5px solid #28a745; }
        .employer { border-right: 5px solid #007bff; }
    </style>
</head>
<body>
    <!-- نوار ناوبری -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/" style="color: #667eea; font-size: 1.5rem;">
                💼 سایت آگهی کار
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <!-- زنگوله اعلان برای جویای کار -->
                <div class="notification-bell" onclick="showNotifications('job_seeker')" title="اعلان‌های جویای کار">
                    🔔
                    <span class="notification-count" id="job-seeker-count">0</span>
                </div>
                <!-- زنگوله اعلان برای کارفرما -->
                <div class="notification-bell" onclick="showNotifications('employer')" title="اعلان‌های کارفرما">
                    🔔
                    <span class="notification-count" id="employer-count">0</span>
                </div>
                <a class="btn btn-main me-2" href="#register-section">ثبت آگهی کار</a>
                <a class="btn btn-main" href="#jobs-section">آگهی‌های موجود</a>
            </div>
        </div>
    </nav>

    <!-- پیام همگانی -->
    {% if global_message %}
    <div class="alert alert-info alert-dismissible fade show global-alert" role="alert">
        <strong>پیام همگانی:</strong> {{ global_message|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="container main-content">
        <!-- کارت خوشامدگویی -->
        <div class="welcome-card">
            <h1 class="display-4 fw-bold mb-4" style="color: #667eea;">به سایت آگهی کار خوش آمدید</h1>
            <p class="lead">پلتفرم پیشرفته برای یافتن کار و نیروی کار در ایران</p>
        </div>

        <!-- بخش ثبت آگهی -->
        <section id="register-section" class="form-container">
            <h2 class="text-center mb-4" style="color: #667eea;">ثبت آگهی کار</h2>
            
            <form method="POST" action="/register" id="job-form">
                <!-- انتخاب نوع کاربر -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="category-btn" onclick="selectUserType('job_seeker')" id="job-seeker-btn">
                            🔍 جویای کار
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="category-btn" onclick="selectUserType('employer')" id="employer-btn">
                            🏢 کارفرما
                        </div>
                    </div>
                </div>

                <input type="hidden" name="job_type" id="job_type" required>

                <!-- انتخاب دسته کار -->
                <h4 class="mb-3" style="color: #667eea;">انتخاب دسته کار:</h4>
                <div class="category-grid">
                    <div class="category-btn" onclick="selectCategory('خیاط')">🧵 خیاط</div>
                    <div class="category-btn" onclick="selectCategory('برق‌کار')">⚡ برق‌کار</div>
                    <div class="category-btn" onclick="selectCategory('نجار')">🔨 نجار</div>
                    <div class="category-btn" onclick="selectCategory('نقاش')">🎨 نقاش</div>
                    <div class="category-btn" onclick="selectCategory('لوله‌کش')">🔧 لوله‌کش</div>
                    <div class="category-btn" onclick="selectCategory('تایل‌کار')">🏠 تایل‌کار</div>
                    <div class="category-btn" onclick="selectCategory('کارگر ساده')">👷 کارگر ساده</div>
                    <div class="category-btn" onclick="selectCategory('راننده')">🚗 راننده</div>
                    <div class="category-btn" onclick="selectCategory('آشپز')">👨‍🍳 آشپز</div>
                    <div class="category-btn" onclick="selectCategory('مکانیک')">🔧 مکانیک</div>
                    <div class="category-btn" onclick="selectCategory('تعمیرکار موبایل')">📱 تعمیرکار موبایل</div>
                    <div class="category-btn" onclick="selectCategory('باغبان')">🌱 باغبان</div>
                    <div class="category-btn" onclick="selectCategory('خانه‌دار')">🏡 خانه‌دار</div>
                    <div class="category-btn" onclick="selectCategory('فروشنده')">🛒 فروشنده</div>
                    <div class="category-btn" onclick="selectCategory('نگهبان')">🛡️ نگهبان</div>
                    <div class="category-btn" onclick="selectCategory('پاکبان')">🧹 پاکبان</div>
                    <div class="category-btn" onclick="selectCategory('بنا')">🧱 بنا</div>
                    <div class="category-btn" onclick="selectCategory('تعمیرکار لوازم خانگی')">🔌 تعمیرکار لوازم خانگی</div>
                    <div class="category-btn" onclick="selectCategory('آرایشگر')">✂️ آرایشگر</div>
                    <div class="category-btn" onclick="selectCategory('دلاک')">💆 دلاک</div>
                </div>

                <input type="hidden" name="category" id="selected_category" required>

                <!-- توضیحات -->
                <div class="mb-3">
                    <label for="description" class="form-label fw-bold">توضیحات و سابقه کار:</label>
                    <textarea class="form-control" name="description" id="description" rows="4" required 
                              placeholder="لطفاً درباره خود، سابقه کار و شرایط کاری خود توضیح دهید..."></textarea>
                </div>

                <!-- شماره تماس -->
                <div class="mb-4">
                    <label for="phone" class="form-label fw-bold">شماره تماس:</label>
                    <input type="tel" class="form-control" name="phone" id="phone" required 
                           placeholder="09123456789">
                </div>

                <button type="submit" class="btn btn-main btn-lg w-100">
                    ✅ ثبت آگهی
                </button>
            </form>
        </section>

        <!-- بخش آگهی‌های موجود -->
        <section id="jobs-section" class="form-container">
            <h2 class="text-center mb-4" style="color: #667eea;">آگهی‌های موجود</h2>
            
            <!-- جستجو -->
            <div class="search-container">
                <div class="row">
                    <div class="col-md-10">
                        <input type="text" class="form-control" id="search-input" 
                               placeholder="جستجو در آگهی‌ها (نام شغل یا توضیحات)...">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-main w-100" onclick="searchJobs()">🔍 جستجو</button>
                    </div>
                </div>
            </div>

            <div id="jobs-container">
                <!-- آگهی‌ها با Ajax لود می‌شوند -->
            </div>
        </section>
    </div>

    <!-- Modal برای اعلان‌ها -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">اعلان‌ها</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notification-content">
                    <!-- اعلان‌ها اینجا لود می‌شوند -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    <button type="button" class="btn btn-danger" id="clear-notifications">پاک کردن همه</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedUserType = '';
        let selectedCategory = '';
        let currentNotificationType = '';

        // انتخاب نوع کاربر
        function selectUserType(type) {
            selectedUserType = type;
            document.getElementById('job_type').value = type;
            
            // تغییر استایل دکمه‌ها
            document.getElementById('job-seeker-btn').classList.remove('active');
            document.getElementById('employer-btn').classList.remove('active');
            document.getElementById(type === 'job_seeker' ? 'job-seeker-btn' : 'employer-btn').classList.add('active');
            
            // تغییر متن placeholder
            const placeholder = type === 'job_seeker' ? 
                'درباره خود، سابقه کار و مهارت‌های خود توضیح دهید...' :
                'درباره شرایط کار، نوع همکاری و مزایای پیشنهادی توضیح دهید...';
            document.getElementById('description').placeholder = placeholder;
        }

        // انتخاب دسته کار
        function selectCategory(category) {
            selectedCategory = category;
            document.getElementById('selected_category').value = category;
            
            // تغییر استایل دکمه‌ها
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // جستجو در آگهی‌ها
        function searchJobs() {
            const query = document.getElementById('search-input').value;
            loadJobs(query);
        }

        // بارگذاری آگهی‌ها
        function loadJobs(searchQuery = '') {
            const url = searchQuery ? `/jobs?search=${encodeURIComponent(searchQuery)}` : '/jobs';
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const jobsContent = doc.querySelector('.container').innerHTML;
                    
                    document.getElementById('jobs-container').innerHTML = jobsContent;
                });
        }

        // نمایش اعلان‌ها
        function showNotifications(type) {
            currentNotificationType = type;
            
            fetch(`/notifications?type=${type}`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const notificationContent = doc.querySelector('.container').innerHTML;
                    
                    document.getElementById('notification-content').innerHTML = notificationContent;
                    
                    const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
                    modal.show();
                });
        }

        // پاک کردن اعلان‌ها
        document.getElementById('clear-notifications').addEventListener('click', function() {
            if (currentNotificationType) {
                fetch(`/clear_notifications?type=${currentNotificationType}`)
                    .then(() => {
                        document.getElementById('notification-content').innerHTML = '<p class="text-center">هیچ اعلانی وجود ندارد</p>';
                        updateNotificationCounts();
                    });
            }
        });

        // بروزرسانی تعداد اعلان‌ها
        function updateNotificationCounts() {
            // جویای کار
            fetch('/notifications?type=job_seeker')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const notifications = doc.querySelectorAll('.job-card');
                    document.getElementById('job-seeker-count').textContent = notifications.length;
                });

            // کارفرما
            fetch('/notifications?type=employer')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const notifications = doc.querySelectorAll('.job-card');
                    document.getElementById('employer-count').textContent = notifications.length;
                });
        }

        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', function() {
            loadJobs();
            updateNotificationCounts();
            
            // جستجو با Enter
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchJobs();
                }
            });

            // بروزرسانی دوره‌ای تعداد اعلان‌ها
            setInterval(updateNotificationCounts, 30000); // هر 30 ثانیه
        });

        // پیام موفقیت ثبت
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% if category == 'success' %}
                        document.addEventListener('DOMContentLoaded', function() {
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show global-alert';
                            alertDiv.innerHTML = `
                                <strong>✅ موفق!</strong> {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            document.body.appendChild(alertDiv);
                            
                            setTimeout(() => {
                                alertDiv.remove();
                            }, 5000);
                        });
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
    </script>
</body>
                      </html>
